# pTU_paper

This repository contains all scripts used to produce the results shown on the paper. Some of these scripts are just shell wrappers around other commands. They have been included as they document the exact params used for the pipeline. To install simply copy them to a folder and execute from there, just make sure that all dependencies are in your PATH. Dependecies are minimal and pretty standard. Perhaps the more exoteric is ani.rb, the Ruby script from [enveomics repository](https://github.com/lmrodriguezr/enveomics) used to calculate the ANI similarity between plasmid genomes. This pipeline has been tested on Ubuntu 16.04 LTS edition but it should be run on any actual Linux/MacOS system.

### Dependencies

- External programs:
  - AcCNET v1.2
  - [ani.rb](https://github.com/lmrodriguezr/enveomics/blob/master/Scripts/ani.rb) from enveomics repository
  - Blast+ v2.6.0
  - HMMER v3.1b2
  - PlasmidFinder v1.3
  - Gephi v0.9.2

- Other software and libraries:
  - Matlab 2019a
  - Pyhton 3.6
  - BioPython v1.69
  - R 3.4
  - Perl v5.26.2
  - BioPerl 1.6.924
  - Easyfig v2.2.2

### Pipeline description

To reproduce the manuscript's results a number of scripts should be executed on a precise order as some steps require the output from previous commands. Not all scripts are documented as some are just simply wrappers around other commands. A broad description of the different steps follows:

##### Plasmid sequences metadata compilation

- __```download_ncbi_taxonomy.sh```__: Generate a database for taxonomy annotations
- __```extract_RefSeq84_database.sh```__: Extract RefSeq plasmid sequences database (modify accordingly to your database version). One of the outputs of this command is ```plasmid.lst```, a file listing all accession numbers of the plasmid dataset
- __```generate_protein_seqs.sh```__: Extract aminoacid sequences from genome GBK files. As argument use the file ```plasmid.lst``` generated by the previous step
- __```extract_plasmid_info.sh```__: Generate the plasmid metadata database ```plasmid.tsv``` using GenBank annotations and taxonomy

##### Relaxase and replicon annotations

- __```assign_mob_classes.sh```__: Find plasmids relaxasome. Relaxase HMM profile database shared from [MOBscan](https://castillo.dicom.unican.es/mobscan_about/). This wrapper's argument is the same ```plasmid.lst``` file previously used
- __```assign_pfinder_classes.sh```__: Type plasmid replicons with PlasmidFinder software and database

##### Compile network topographies

- __```list_subgroups.sh```__: Generate different subsets of plasmids (Enterobacterales, Escherichia, etc). Some accession numbers are blacklisted as were found to not be real plasmids
- __```append_pGroup_annotation.sh```__: This is a bit underhanded but we update here the plasmid metadata database with the the pTUs manually defined based on the output of next commands
- __```accnet_RefSeq84.sh```__: Execute AcCNET to generate the plasmidome/ORFeome bipartite network. Use Gephi with the output of this script to produce the network layout
- __```ani_RefSeq84.sh```__: This is the main step of our analysis as it produces the files later used with Gephi to layout the pTU network. This script combines two distinct functions:
  - ___```calculate_ani_distances_p.py```___: Produce the list of ANI pairwise comparisons. This script is, as it is at the moment, very inefficient to execute on a personal computer and will take several weeks for completion
  - ___```genome_similarity_nerwork.py```___: Take the ANI comparisons and generate the file of edge's similarity and distance measures

##### t-SNE network visualization

- __```generate_adjacency_matrices.py```__: Transform pairwise list of ANI similariry measures on the usual network adjacency matrix
- __```tsne_adjacency.m```__: Apply t-SNE dimensionality reduction algorithm to the pTU network adjacency matrix

##### PID: algorithm for automatic pTU classification

This algorithm has been implemented with the Matlab files ```setglobal.m```, ```divide.m```, ```escribe_componentes.m```, ```keephojas.m``` and ```dibuja.m```

To execute simply enter the following commands on Matlab Command Window:

```
>> setglobal;
>> divide(G, '0');
>> keephojas;
```

##### Host range visual representation

- __```bipartite_kept_190823.sh```__: Generation of the bipartite network used for host range visualization. Use Gephi to convert on a monopartite network of hosts present per pTU

##### Checking the networks

- __```Connections_v2.py```__: Calculate plasmid/HpC statistics of bipartite network stratified by the taxonomic levels of nodes
- __```Connection_plots.R```__: R script for visualization of ```Connections_v2.py``` output

- __```pANI_prepare_data.sh```__: Compile a BLAST database of plasmid fragments sized for aligment fraction (AF) calcutation
- __```pANI_Enterobacterales.sh```__: Generate pairwise list of aligment fraction (AF) results. Again, this step will take too long to execute on a personal computer

- __```summarize_pGroups_info.sh```__: Generate a basic description of pTUs composition
- __```calculate_cluster_density.py```__: Calculate inter and intra-cluster density of pTU clusters
- __```check_database_redundancy.py```__: Verify the percentage of plasmid duplication on pTU clusters

### License

All this software is released under the GPL license.
